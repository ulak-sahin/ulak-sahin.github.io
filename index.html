<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İlahi Kütüphanesi</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="notifications"></div>
  <div class="container">
    <div class="header-row">
      <h1>🎵 İlahi Sözleri</h1>
      <button id="themeBtn" class="button-animations" onclick="toggleDarkMode()">
        <svg id="sun-symbol" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="4"/>
          <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32 1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
        </svg>
        <svg id="moon-symbol" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9"/>
        </svg>
      </button>
    </div>

    <div class="search-container">
      <input id="search-input" type="text" placeholder="İlahi Ara..." />
      <button id="clear-search">×</button>
    </div>

    <div id="filter-chips" class="filter-row">
      <div class="chip-row" id="chip-language"></div>
      <div class="chip-row" id="chip-timeline"></div>
      <div class="chip-row">
        <select id="singer-select" class="chip-like-select">
          <option value="">Tüm Sanatçılar</option>
        </select>
      </div>
    </div>
    
    <ul id="lyrics-list"></ul>
  </div>

  <script>
    const repoOwner = 'ulak-sahin';  // 🔁 change to your GitHub username
    const repoName = 'ulak-sahin.github.io';  // 🔁 change to your repo name
    const folderPath = 'lyrics';

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    async function loadLyricsList() {
      const res = await fetch('lyrics_metadata.json');
      const metadata = await res.json();

      const filters = { language: null, timeline: null, singer: "" };

      const categories = {
        language: [...new Set(metadata.map(x => x.language))],
        timeline: [...new Set(metadata.map(x => x.timeline))],
        singer: [...new Set(metadata.map(x => x.singer))]
      };

      function createChips(category) {
        const container = document.getElementById(`chip-${category}`);
        categories[category].forEach(value => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = value;
          chip.dataset.category = category;
          chip.dataset.value = value;
          chip.addEventListener('click', () => {
            filters[category] = filters[category] === value ? null : value;

            // Update chip visuals
            document.querySelectorAll(`.chip[data-category="${category}"]`)
              .forEach(c => c.classList.remove('active'));
            if (filters[category]) chip.classList.add('active');

            renderList();
          });
          container.appendChild(chip);
        });
      }

      // Add language and timeline chips
      createChips('language');
      createChips('timeline');

      // Populate singer dropdown
      const singerSelect = document.getElementById('singer-select');
      categories.singer.sort((a, b) => a.localeCompare(b));

      categories.singer.forEach(singer => {
        const opt = document.createElement('option');
        opt.value = singer;
        opt.textContent = singer;
        singerSelect.appendChild(opt);
      });

      singerSelect.addEventListener('change', () => {
        filters.singer = singerSelect.value;

        if (filters.singer) {
          singerSelect.classList.add('active');
        } else {
          singerSelect.classList.remove('active');
        }

        renderList();
      });

      function renderList() {
        const list = document.getElementById('lyrics-list');
        list.innerHTML = '';

        const query = normalize(searchInput.value);

        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        const filtered = metadata.filter(song => {
          const isUnchecked = song.timestamp === null;
          const isSearching = query.length > 0;

          return (!filters.language || song.language === filters.language) &&
                (!filters.timestamp || song.timestamp === filters.timestamp) &&
                (!filters.timeline || song.timeline === filters.timeline) &&
                (!filters.singer || song.singer === filters.singer) &&
                normalize(song.filename).includes(query);
        });

        filtered.forEach(song => {
          const songTS = song.timestamp
          const songDate = new Date(songTS);
          const isNew = songDate > oneWeekAgo;
          const isUnchecked = songTS === null
          const tag = isUnchecked
            ? '<span class="unchecked-badge">DOĞRULANMAMIŞ</span>'
            : isNew
              ? '<span class="new-badge">YENİ</span>'
              : '';

          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `viewer.html?song=${encodeURIComponent(song.filename)}`;
          a.textContent = song.filename.replace('.md', '');
          a.innerHTML = `${song.filename.replace('.md', '')} ${tag}`;
          a.className = 'song-item';
          li.appendChild(a);
          list.appendChild(li);
        });
        
        //Send searched string to form
        if (filtered.length === 0 && query.length > 1) {
          const wrapper = document.createElement('div');
          wrapper.style.marginTop = '15px';
          wrapper.style.display = 'flex';
          wrapper.style.flexDirection = 'column';
          wrapper.style.alignItems = 'center';
          wrapper.style.gap = '10px';
          
          const notFoundSpan = document.createElement('span');
          notFoundSpan.textContent = "Aradığın ilahiyi bulamadık... ";
          wrapper.appendChild(notFoundSpan);

          const wrapperDiv = document.createElement('div');
          wrapperDiv.style.display = 'flex';
          wrapperDiv.style.flexDirection = 'row';
          wrapperDiv.style.alignItems = 'center';
          wrapperDiv.style.gap = '10px';

          const searchGoogleBtn = document.createElement('button');
          searchGoogleBtn.id = "searchGoogleBtn";
          searchGoogleBtn.className = "colorBtn button-animations";
          searchGoogleBtn.textContent = `Google'da ara`;
          searchGoogleBtn.onclick = () => searchOnGoogle();
          wrapperDiv.appendChild(searchGoogleBtn);

          const sendSearchBtn = document.createElement('button');
          sendSearchBtn.id = "sendSearchBtn";
          sendSearchBtn.className = "colorBtn button-animations";
          sendSearchBtn.textContent = `Yöneticiye söyle`;
          sendSearchBtn.onclick = () => handleMissingSearch(query);
          wrapperDiv.appendChild(sendSearchBtn);

          wrapper.appendChild(wrapperDiv)
          list.appendChild(wrapper);
        }
      }

      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', () => renderList());
      const clearBtn = document.getElementById('clear-search');

      searchInput.addEventListener('input', () => {
        clearBtn.style.display = searchInput.value ? 'block' : 'none';
        renderList();
      });

      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        renderList();
        searchInput.focus();
      });

      renderList();
    }
    loadLyricsList();

    function normalize(str) {
      return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, '') // Remove accents
        .replace(/[^a-z0-9]/g, ''); // Remove non-alphanumerics
    }

    let lastSentQuery = '';

    function handleMissingSearch(query) {
      if (query.length < 5) {
        notify("İlahinin tam ismini yazman gerek!", type='error',);
      }
      else if (query === lastSentQuery){
        notify("Bunu zaten gönderdin, başka bir şey dene!", type='error',);
      }
      else {
        sendMissingSearch(document.getElementById('search-input').value);
        lastSentQuery = query;
      }
    }

    function sendMissingSearch(query) {
      fetch("https://formspree.io/f/mjkrqedw", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ search: query })
      });

      notify("Bildirdiğin için teşekkür ederiz. Bi ara ekleriz inşallah...");
    }

    function searchOnGoogle() {
      const url = "https://www.google.com/search?q=" + encodeURIComponent(document.getElementById('search-input').value + " şarkı sözleri");
      window.open(url, "_blank");
    }

    function notify(message, type = 'success', timeout = 3000) {
      const container = document.getElementById('notifications');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;

      container.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
      }, timeout);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

  </script>
  
</body>
</html>
